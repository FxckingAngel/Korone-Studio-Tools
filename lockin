--//=====================================================
--// Korone Studio Tools - Standalone
--//  ‚Ä¢ Emoji UI Hub
--//  ‚Ä¢ Studio-like Explorer
--//  ‚Ä¢ Working Remote Spy
--//  ‚Ä¢ Script / Property Editor + File Export
--//=====================================================

-------------------------------
-- Services / basics
-------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()

local function safe(fn, ...)
	local ok, res = pcall(fn, ...)
	if not ok then warn("[KoroneStudio]", res) end
	return ok, res
end

-------------------------------
-- Korone Studio Util (FS + scripts + decomposer)
-------------------------------
local KS_UTIL = {}

-- filesystem helpers
function KS_UTIL.canFS()
	return typeof(writefile) == "function" and typeof(readfile) == "function"
end

function KS_UTIL.ensureFolders(path)
	if not KS_UTIL.canFS() then return end
	if typeof(makefolder) ~= "function" or typeof(isfolder) ~= "function" then return end

	local cur = ""
	for seg in string.gmatch(path, "[^/]+") do
		if cur == "" then cur = seg else cur = cur .. "/" .. seg end
		if not isfolder(cur) then
			makefolder(cur)
		end
	end
end

function KS_UTIL.writeFile(path, contents)
	if not KS_UTIL.canFS() then
		error("Filesystem not supported in this exploit.")
	end
	local ok, err = pcall(writefile, path, contents)
	if not ok then error("Failed to write file '" .. path .. "': " .. tostring(err)) end
end

-- decomposer
local function decomposeInstance(inst, depth, maxDepth)
	depth = depth or 0
	maxDepth = maxDepth or 5

	if depth > maxDepth then
		return { __truncated = true, Name = inst.Name, ClassName = inst.ClassName }
	end

	local info = {
		Name = inst.Name,
		ClassName = inst.ClassName,
		Properties = {},
		Children = {},
	}

	local function prop(p)
		local ok, v = pcall(function() return inst[p] end)
		if ok then info.Properties[p] = v end
	end

	for _, p in ipairs({
		"Name","ClassName","Parent","Archivable",
		"Transparency","Anchored","CanCollide",
		"Size","Position","Text","Value","BrickColor","Color"
	}) do
		prop(p)
	end

	for _, child in ipairs(inst:GetChildren()) do
		table.insert(info.Children, decomposeInstance(child, depth+1, maxDepth))
	end

	return info
end

function KS_UTIL.decompose(root, maxDepth)
	maxDepth = maxDepth or 5
	if typeof(root) == "string" then
		local current = game
		for token in string.gmatch(root, "[^%.]+") do
			local child = current:FindFirstChild(token)
			if not child then error("Cannot resolve '"..token.."' from "..current:GetFullName()) end
			current = child
		end
		root = current
	end
	if typeof(root) ~= "Instance" then
		error("decompose expects Instance or path string")
	end
	local tree = decomposeInstance(root, 0, maxDepth)
	print("[KoroneStudio] Decomposed:", root:GetFullName())
	print(HttpService:JSONEncode(tree))
	return tree
end

function KS_UTIL.exportInstance(root, opts)
	opts = opts or {}
	local folder = opts.folder or ("KoroneExports/"..tostring(game.PlaceId))
	local name   = opts.name   or root.Name
	local maxDepth = opts.maxDepth or 6

	KS_UTIL.ensureFolders(folder)
	local tree = KS_UTIL.decompose(root, maxDepth)
	local json = HttpService:JSONEncode(tree)
	local path = folder.."/"..name..".json"
	KS_UTIL.writeFile(path, json)
	print("[KoroneStudio] Exported instance to:", path)
	return path
end

-- scripts
local function tryDecompile(inst)
	if typeof(decompile) == "function" then
		local ok, src = pcall(decompile, inst)
		if ok and typeof(src) == "string" then return src end
	end
	if inst:IsA("LuaSourceContainer") then
		local ok, src = pcall(function() return inst.Source end)
		if ok then return src end
	end
	return "-- failed to get source for "..inst:GetFullName()
end

function KS_UTIL.getScriptSource(inst)
	if not inst or not inst:IsA("LuaSourceContainer") then
		error("getScriptSource expects Script/LocalScript/ModuleScript")
	end
	return tryDecompile(inst)
end

function KS_UTIL.applyScriptSource(inst, src)
	if not inst or not inst:IsA("LuaSourceContainer") then
		error("applyScriptSource expects Script/LocalScript/ModuleScript")
	end
	local ok, err = pcall(function() inst.Source = src end)
	if not ok then error("Failed to apply script source: "..tostring(err)) end
end

function KS_UTIL.exportScript(inst, folder)
	folder = folder or ("KoroneExports/"..tostring(game.PlaceId).."/Scripts")
	KS_UTIL.ensureFolders(folder)
	local src = KS_UTIL.getScriptSource(inst)
	local safeName = inst.Name:gsub("[^%w_]+","_")
	local path = folder.."/"..safeName.."_"..inst.ClassName..".lua"
	KS_UTIL.writeFile(path, src)
	print("[KoroneStudio] Exported script to:", path)
	return path
end

_G.KS_UTIL = KS_UTIL

-------------------------------
-- Korone Editor UI
-------------------------------
local KS_Editor = { Gui = nil, CurrentInstance = nil }

local function makeDraggable(header, frame)
	local dragging, dragStart, startPos
	header.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position
		end
	end)
	header.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(
				startPos.X.Scale, startPos.X.Offset + delta.X,
				startPos.Y.Scale, startPos.Y.Offset + delta.Y
			)
		end
	end)
end

local function createEditorGui()
	if KS_Editor.Gui then return end

	local gui = Instance.new("ScreenGui")
	gui.Name = "KoroneEditor"
	gui.ResetOnSpawn = false
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	gui.Parent = CoreGui

	local main = Instance.new("Frame")
	main.AnchorPoint = Vector2.new(0.5,0.5)
	main.Position = UDim2.new(0.5,0,0.5,0)
	main.Size = UDim2.new(0,740,0,430)
	main.BackgroundColor3 = Color3.fromRGB(24,24,26)
	main.BorderSizePixel = 0
	main.Parent = gui
	local mc = Instance.new("UICorner"); mc.CornerRadius = UDim.new(0,10); mc.Parent = main

	local top = Instance.new("Frame")
	top.Size = UDim2.new(1,0,0,32)
	top.BackgroundColor3 = Color3.fromRGB(30,30,34)
	top.BorderSizePixel = 0
	top.Parent = main
	local tc = Instance.new("UICorner"); tc.CornerRadius = UDim.new(0,10); tc.Parent = top

	local title = Instance.new("TextLabel")
	title.BackgroundTransparency = 1
	title.Size = UDim2.new(1,-170,1,0)
	title.Position = UDim2.new(0,12,0,0)
	title.Font = Enum.Font.SourceSansSemibold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.TextColor3 = Color3.new(1,1,1)
	title.Text = "‚úèÔ∏è Korone Script Editor"
	title.Parent = top

	local btnClose = Instance.new("TextButton")
	btnClose.Size = UDim2.new(0,26,0,22)
	btnClose.Position = UDim2.new(1,-32,0.5,-11)
	btnClose.BackgroundColor3 = Color3.fromRGB(70,35,35)
	btnClose.BorderSizePixel = 0
	btnClose.Font = Enum.Font.SourceSansBold
	btnClose.Text = "X"
	btnClose.TextSize = 16
	btnClose.TextColor3 = Color3.new(1,1,1)
	btnClose.Parent = top
	local bc = Instance.new("UICorner"); bc.CornerRadius = UDim.new(0,6); bc.Parent = btnClose

	local btnSave = Instance.new("TextButton")
	btnSave.Size = UDim2.new(0,80,0,22)
	btnSave.Position = UDim2.new(1,-200,0.5,-11)
	btnSave.BackgroundColor3 = Color3.fromRGB(45,90,45)
	btnSave.BorderSizePixel = 0
	btnSave.Font = Enum.Font.SourceSansSemibold
	btnSave.Text = "üíæ Save"
	btnSave.TextSize = 14
	btnSave.TextColor3 = Color3.new(1,1,1)
	btnSave.Parent = top
	local bs = Instance.new("UICorner"); bs.CornerRadius = UDim.new(0,6); bs.Parent = btnSave

	local btnExport = Instance.new("TextButton")
	btnExport.Size = UDim2.new(0,80,0,22)
	btnExport.Position = UDim2.new(1,-116,0.5,-11)
	btnExport.BackgroundColor3 = Color3.fromRGB(45,60,100)
	btnExport.BorderSizePixel = 0
	btnExport.Font = Enum.Font.SourceSansSemibold
	btnExport.Text = "üì§ Export"
	btnExport.TextSize = 14
	btnExport.TextColor3 = Color3.new(1,1,1)
	btnExport.Parent = top
	local be = Instance.new("UICorner"); be.CornerRadius = UDim.new(0,6); be.Parent = btnExport

	local content = Instance.new("Frame")
	content.Position = UDim2.new(0,0,0,32)
	content.Size = UDim2.new(1,0,1,-32)
	content.BackgroundTransparency = 1
	content.Parent = main

	local tabs = Instance.new("Frame")
	tabs.Size = UDim2.new(0,120,1,0)
	tabs.BackgroundColor3 = Color3.fromRGB(30,30,34)
	tabs.BorderSizePixel = 0
	tabs.Parent = content
	local tbc = Instance.new("UICorner"); tbc.CornerRadius = UDim.new(0,10); tbc.Parent = tabs

	local scriptTab = Instance.new("TextButton")
	scriptTab.Size = UDim2.new(1,0,0,30)
	scriptTab.BackgroundColor3 = Color3.fromRGB(40,40,48)
	scriptTab.BorderSizePixel = 0
	scriptTab.Font = Enum.Font.SourceSansSemibold
	scriptTab.Text = "üìú Script"
	scriptTab.TextSize = 16
	scriptTab.TextColor3 = Color3.new(1,1,1)
	scriptTab.Parent = tabs

	local propTab = Instance.new("TextButton")
	propTab.Size = UDim2.new(1,0,0,30)
	propTab.Position = UDim2.new(0,0,0,32)
	propTab.BackgroundColor3 = Color3.fromRGB(26,26,30)
	propTab.BorderSizePixel = 0
	propTab.Font = Enum.Font.SourceSansSemibold
	propTab.Text = "‚öôÔ∏è Properties"
	propTab.TextSize = 16
	propTab.TextColor3 = Color3.fromRGB(0.8,0.8,0.8)
	propTab.Parent = tabs

	local right = Instance.new("Frame")
	right.Position = UDim2.new(0,124,0,0)
	right.Size = UDim2.new(1,-124,1,0)
	right.BackgroundColor3 = Color3.fromRGB(20,20,22)
	right.BorderSizePixel = 0
	right.Parent = content

	-- search
	local searchBox = Instance.new("TextBox")
	searchBox.Size = UDim2.new(0,200,0,24)
	searchBox.Position = UDim2.new(0,6,0,6)
	searchBox.BackgroundColor3 = Color3.fromRGB(26,26,30)
	searchBox.BorderSizePixel = 0
	searchBox.Font = Enum.Font.SourceSans
	searchBox.PlaceholderText = "üîç search in script..."
	searchBox.ClearTextOnFocus = false
	searchBox.TextColor3 = Color3.new(1,1,1)
	searchBox.TextSize = 14
	searchBox.Parent = right
	local sbc = Instance.new("UICorner"); sbc.CornerRadius = UDim.new(0,6); sbc.Parent = searchBox

	local searchNext = Instance.new("TextButton")
	searchNext.Size = UDim2.new(0,70,0,24)
	searchNext.Position = UDim2.new(0,210,0,6)
	searchNext.BackgroundColor3 = Color3.fromRGB(45,45,60)
	searchNext.BorderSizePixel = 0
	searchNext.Font = Enum.Font.SourceSansSemibold
	searchNext.Text = "Next"
	searchNext.TextSize = 14
	searchNext.TextColor3 = Color3.new(1,1,1)
	searchNext.Parent = right
	local snc = Instance.new("UICorner"); snc.CornerRadius = UDim.new(0,6); snc.Parent = searchNext

	-- script area
	local scriptScroll = Instance.new("ScrollingFrame")
	scriptScroll.Name = "ScriptScroll"
	scriptScroll.Position = UDim2.new(0,6,0,34)
	scriptScroll.Size = UDim2.new(1,-12,1,-40)
	scriptScroll.BackgroundColor3 = Color3.fromRGB(16,16,18)
	scriptScroll.BorderSizePixel = 0
	scriptScroll.ScrollBarThickness = 6
	scriptScroll.CanvasSize = UDim2.new(0,0,0,0)
	scriptScroll.Parent = right
	local ssc = Instance.new("UICorner"); ssc.CornerRadius = UDim.new(0,6); ssc.Parent = scriptScroll

	local codeBox = Instance.new("TextBox")
	codeBox.BackgroundTransparency = 1
	codeBox.Size = UDim2.new(1,-8,1,-8)
	codeBox.Position = UDim2.new(0,4,0,4)
	codeBox.ClearTextOnFocus = false
	codeBox.MultiLine = true
	codeBox.TextXAlignment = Enum.TextXAlignment.Left
	codeBox.TextYAlignment = Enum.TextYAlignment.Top
	codeBox.Font = Enum.Font.Code
	codeBox.TextSize = 15
	codeBox.TextColor3 = Color3.new(1,1,1)
	codeBox.Text = ""
	codeBox.Parent = scriptScroll

	codeBox:GetPropertyChangedSignal("TextBounds"):Connect(function()
		scriptScroll.CanvasSize = UDim2.new(0,0,0,codeBox.TextBounds.Y+12)
	end)

	-- properties area
	local propFrame = Instance.new("ScrollingFrame")
	propFrame.Name = "PropFrame"
	propFrame.Position = UDim2.new(0,6,0,34)
	propFrame.Size = UDim2.new(1,-12,1,-40)
	propFrame.BackgroundColor3 = Color3.fromRGB(16,16,18)
	propFrame.BorderSizePixel = 0
	propFrame.ScrollBarThickness = 6
	propFrame.CanvasSize = UDim2.new(0,0,0,0)
	propFrame.Visible = false
	propFrame.Parent = right
	local pfc = Instance.new("UICorner"); pfc.CornerRadius = UDim.new(0,6); pfc.Parent = propFrame

	local propLayout = Instance.new("UIListLayout")
	propLayout.Padding = UDim.new(0,4)
	propLayout.FillDirection = Enum.FillDirection.Vertical
	propLayout.SortOrder = Enum.SortOrder.LayoutOrder
	propLayout.Parent = propFrame

	local function refreshProps(inst)
		for _, child in ipairs(propFrame:GetChildren()) do
			if child:IsA("Frame") then child:Destroy() end
		end
		if not inst then return end

		local show = {"Name","ClassName","Archivable","Transparency","Anchored","CanCollide","Text","Value"}
		for _, propName in ipairs(show) do
			local ok, val = pcall(function() return inst[propName] end)
			if ok then
				local row = Instance.new("Frame")
				row.Size = UDim2.new(1,-8,0,26)
				row.BackgroundTransparency = 1
				row.Parent = propFrame

				local lbl = Instance.new("TextLabel")
				lbl.BackgroundTransparency = 1
				lbl.Size = UDim2.new(0.35,0,1,0)
				lbl.Font = Enum.Font.SourceSans
				lbl.TextSize = 14
				lbl.TextXAlignment = Enum.TextXAlignment.Left
				lbl.TextColor3 = Color3.new(1,1,1)
				lbl.Text = propName
				lbl.Parent = row

				local box = Instance.new("TextBox")
				box.Size = UDim2.new(0.65,-4,1,0)
				box.Position = UDim2.new(0.35,4,0,0)
				box.BackgroundColor3 = Color3.fromRGB(26,26,30)
				box.BorderSizePixel = 0
				box.ClearTextOnFocus = false
				box.Font = Enum.Font.Code
				box.TextSize = 14
				box.TextXAlignment = Enum.TextXAlignment.Left
				box.TextColor3 = Color3.new(1,1,1)
				box.Text = tostring(val)
				box.Parent = row
				local bc2 = Instance.new("UICorner"); bc2.CornerRadius = UDim.new(0,4); bc2.Parent = box

				local original = val
				box.FocusLost:Connect(function(enter)
					if not enter then return end
					local text = box.Text
					local newVal = text
					local t = typeof(original)
					if t == "number" then
						newVal = tonumber(text) or original
					elseif t == "boolean" then
						local l = string.lower(text)
						newVal = (l=="true" or l=="1" or l=="yes")
					end
					local okSet, err = pcall(function() inst[propName] = newVal end)
					if not okSet then
						warn("[KoroneEditor] Failed to set "..propName..": "..tostring(err))
						box.Text = tostring(original)
					else
						original = newVal
					end
				end)
			end
		end
		propFrame.CanvasSize = UDim2.new(0,0,0,propLayout.AbsoluteContentSize.Y+8)
	end

	local function selectTab(which)
		if which == "script" then
			scriptScroll.Visible = true
			propFrame.Visible = false
			scriptTab.BackgroundColor3 = Color3.fromRGB(40,40,48)
			propTab.BackgroundColor3 = Color3.fromRGB(26,26,30)
		else
			scriptScroll.Visible = false
			propFrame.Visible = true
			scriptTab.BackgroundColor3 = Color3.fromRGB(26,26,30)
			propTab.BackgroundColor3 = Color3.fromRGB(40,40,48)
		end
	end

	scriptTab.MouseButton1Click:Connect(function() selectTab("script") end)
	propTab.MouseButton1Click:Connect(function() selectTab("props") end)

	-- search logic
	local lastIndex = 1
	local function doSearch()
		local q = searchBox.Text
		local text = codeBox.Text
		if q=="" or text=="" then return end
		local start = string.find(string.lower(text), string.lower(q), lastIndex, true)
		if not start then start = string.find(string.lower(text), string.lower(q), 1, true) end
		if start then
			local before = string.sub(text,1,start)
			local _, lines = string.gsub(before,"\n","")
			codeBox.CursorPosition = start + #q
			scriptScroll.CanvasPosition = Vector2.new(0,(lines-1)*16)
			lastIndex = start + #q
		end
	end
	searchNext.MouseButton1Click:Connect(doSearch)
	searchBox.FocusLost:Connect(function(enter)
		if enter then lastIndex = 1; doSearch() end
	end)

	-- buttons
	btnClose.MouseButton1Click:Connect(function()
		gui.Enabled = false
		KS_Editor.CurrentInstance = nil
	end)

	btnSave.MouseButton1Click:Connect(function()
		local inst = KS_Editor.CurrentInstance
		if not inst then return end
		if inst:IsA("LuaSourceContainer") then
			local src = codeBox.Text or ""
			safe(function()
				KS_UTIL.applyScriptSource(inst, src)
				KS_UTIL.exportScript(inst)
			end)
			print("[KoroneEditor] Saved script + exported file.")
		else
			refreshProps(inst)
		end
	end)

	btnExport.MouseButton1Click:Connect(function()
		local inst = KS_Editor.CurrentInstance
		if not inst then return end
		if inst:IsA("LuaSourceContainer") then
			safe(KS_UTIL.exportScript, inst)
		else
			safe(KS_UTIL.exportInstance, inst, {name = inst.Name})
		end
	end)

	makeDraggable(top, main)

	KS_Editor.Gui = gui
	KS_Editor.Widgets = {
		Title = title,
		CodeBox = codeBox,
		SelectTab = selectTab,
		RefreshProps = refreshProps,
	}
end

function KS_Editor.Open(inst)
	if not inst or typeof(inst) ~= "Instance" then
		error("KoroneEditor.Open expects an Instance")
	end
	createEditorGui()
	KS_Editor.Gui.Enabled = true
	KS_Editor.CurrentInstance = inst

	local w = KS_Editor.Widgets
	w.Title.Text = ("‚úèÔ∏è Korone Editor ‚Äî %s (%s)"):format(inst.Name, inst.ClassName)
	if inst:IsA("LuaSourceContainer") then
		w.CodeBox.Text = KS_UTIL.getScriptSource(inst)
		w.SelectTab("script")
	else
		w.CodeBox.Text = "-- Not a script. Use the ‚öôÔ∏è Properties tab."
		w.SelectTab("props")
	end
	w.RefreshProps(inst)
end

_G.KS_Editor = KS_Editor

-------------------------------
-- Korone Explorer (Studio-like tree)
-------------------------------
local KS_Explorer = { Gui = nil, Selected = nil }

local function createExplorerGui()
	if KS_Explorer.Gui then return end

	local gui = Instance.new("ScreenGui")
	gui.Name = "KoroneExplorer"
	gui.ResetOnSpawn = false
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	gui.Enabled = false
	gui.Parent = CoreGui

	local main = Instance.new("Frame")
	main.AnchorPoint = Vector2.new(0,0.5)
	main.Position = UDim2.new(0,16,0.5,0)
	main.Size = UDim2.new(0,460,0,380)
	main.BackgroundColor3 = Color3.fromRGB(18,18,20)
	main.BorderSizePixel = 0
	main.Parent = gui
	local mc = Instance.new("UICorner"); mc.CornerRadius = UDim.new(0,10); mc.Parent = main

	local top = Instance.new("Frame")
	top.Size = UDim2.new(1,0,0,30)
	top.BackgroundColor3 = Color3.fromRGB(26,26,30)
	top.BorderSizePixel = 0
	top.Parent = main
	local tc = Instance.new("UICorner"); tc.CornerRadius = UDim.new(0,10); tc.Parent = top

	local title = Instance.new("TextLabel")
	title.BackgroundTransparency = 1
	title.Size = UDim2.new(1,-90,1,0)
	title.Position = UDim2.new(0,8,0,0)
	title.Font = Enum.Font.SourceSansSemibold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.TextColor3 = Color3.new(1,1,1)
	title.Text = "üóÇ Korone Explorer"
	title.Parent = top

	local btnClose = Instance.new("TextButton")
	btnClose.Size = UDim2.new(0,26,0,22)
	btnClose.Position = UDim2.new(1,-30,0.5,-11)
	btnClose.BackgroundColor3 = Color3.fromRGB(70,35,35)
	btnClose.BorderSizePixel = 0
	btnClose.Font = Enum.Font.SourceSansBold
	btnClose.Text = "X"
	btnClose.TextSize = 16
	btnClose.TextColor3 = Color3.new(1,1,1)
	btnClose.Parent = top
	local bcc = Instance.new("UICorner"); bcc.CornerRadius = UDim.new(0,6); bcc.Parent = btnClose

	local content = Instance.new("Frame")
	content.Position = UDim2.new(0,0,0,30)
	content.Size = UDim2.new(1,0,1,-30)
	content.BackgroundTransparency = 1
	content.Parent = main

	local tree = Instance.new("ScrollingFrame")
	tree.Name = "Tree"
	tree.Position = UDim2.new(0,4,0,4)
	tree.Size = UDim2.new(0.5,-6,1,-8)
	tree.BackgroundColor3 = Color3.fromRGB(20,20,22)
	tree.BorderSizePixel = 0
	tree.ScrollBarThickness = 6
	tree.CanvasSize = UDim2.new(0,0,0,0)
	tree.Parent = content
	local tc2 = Instance.new("UICorner"); tc2.CornerRadius = UDim.new(0,6); tc2.Parent = tree

	local treeLayout = Instance.new("UIListLayout")
	treeLayout.Padding = UDim.new(0,2)
	treeLayout.FillDirection = Enum.FillDirection.Vertical
	treeLayout.SortOrder = Enum.SortOrder.LayoutOrder
	treeLayout.Parent = tree

	local right = Instance.new("Frame")
	right.Position = UDim2.new(0.5,2,0,4)
	right.Size = UDim2.new(0.5,-6,1,-8)
	right.BackgroundColor3 = Color3.fromRGB(20,20,22)
	right.BorderSizePixel = 0
	right.Parent = content
	local rc = Instance.new("UICorner"); rc.CornerRadius = UDim.new(0,6); rc.Parent = right

	local nameLabel = Instance.new("TextLabel")
	nameLabel.BackgroundTransparency = 1
	nameLabel.Size = UDim2.new(1,-10,0,24)
	nameLabel.Position = UDim2.new(0,5,0,5)
	nameLabel.Font = Enum.Font.SourceSansSemibold
	nameLabel.TextSize = 18
	nameLabel.TextXAlignment = Enum.TextXAlignment.Left
	nameLabel.TextColor3 = Color3.new(1,1,1)
	nameLabel.Text = "Instance: (none)"
	nameLabel.Parent = right

	local btnEdit = Instance.new("TextButton")
	btnEdit.Size = UDim2.new(0,120,0,24)
	btnEdit.Position = UDim2.new(0,6,0,34)
	btnEdit.BackgroundColor3 = Color3.fromRGB(56,102,65)
	btnEdit.BorderSizePixel = 0
	btnEdit.Font = Enum.Font.SourceSansSemibold
	btnEdit.Text = "‚úèÔ∏è Open Editor"
	btnEdit.TextSize = 14
	btnEdit.TextColor3 = Color3.new(1,1,1)
	btnEdit.Parent = right
	local bec = Instance.new("UICorner"); bec.CornerRadius = UDim.new(0,6); bec.Parent = btnEdit

	local btnExport = Instance.new("TextButton")
	btnExport.Size = UDim2.new(0,120,0,24)
	btnExport.Position = UDim2.new(0,134,0,34)
	btnExport.BackgroundColor3 = Color3.fromRGB(59,89,152)
	btnExport.BorderSizePixel = 0
	btnExport.Font = Enum.Font.SourceSansSemibold
	btnExport.Text = "üì§ Export JSON"
	btnExport.TextSize = 14
	btnExport.TextColor3 = Color3.new(1,1,1)
	btnExport.Parent = right
	local bex = Instance.new("UICorner"); bex.CornerRadius = UDim.new(0,6); bex.Parent = btnExport

	local propList = Instance.new("ScrollingFrame")
	propList.Name = "Props"
	propList.Position = UDim2.new(0,6,0,64)
	propList.Size = UDim2.new(1,-12,1,-70)
	propList.BackgroundTransparency = 1
	propList.BorderSizePixel = 0
	propList.ScrollBarThickness = 6
	propList.CanvasSize = UDim2.new(0,0,0,0)
	propList.Parent = right

	local propLayout = Instance.new("UIListLayout")
	propLayout.Padding = UDim.new(0,2)
	propLayout.FillDirection = Enum.FillDirection.Vertical
	propLayout.SortOrder = Enum.SortOrder.LayoutOrder
	propLayout.Parent = propList

	local function addPropRow(name, val)
		local row = Instance.new("TextLabel")
		row.BackgroundTransparency = 1
		row.Size = UDim2.new(1,-4,0,18)
		row.Font = Enum.Font.SourceSans
		row.TextSize = 13
		row.TextXAlignment = Enum.TextXAlignment.Left
		row.TextColor3 = Color3.new(1,1,1)
		row.Text = name.." = "..tostring(val)
		row.Parent = propList
	end

	local function iconFor(inst)
		if inst:IsA("Folder") or inst:IsA("Model") then return "üìÅ"
		elseif inst:IsA("Script") or inst:IsA("LocalScript") then return "üìú"
		elseif inst:IsA("ModuleScript") then return "üì¶"
		elseif inst:IsA("RemoteEvent") or inst:IsA("RemoteFunction") then return "üì°"
		elseif inst:IsA("Part") or inst:IsA("MeshPart") then return "üß±"
		elseif inst:IsA("ScreenGui") then return "üñº"
		else return "üîπ" end
	end

	local function buildTree(inst, depth)
		depth = depth or 0
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1,-4,0,22)
		btn.BackgroundColor3 = Color3.fromRGB(26,26,30)
		btn.BorderSizePixel = 0
		btn.AutoButtonColor = true
		btn.Font = Enum.Font.SourceSans
		btn.TextSize = 14
		btn.TextXAlignment = Enum.TextXAlignment.Left
		btn.TextColor3 = Color3.new(1,1,1)
		btn.Text = string.rep("   ", depth)..iconFor(inst).." "..inst.Name.." ["..inst.ClassName.."]"
		btn.Parent = tree
		local bc3 = Instance.new("UICorner"); bc3.CornerRadius = UDim.new(0,4); bc3.Parent = btn

		btn.MouseButton1Click:Connect(function()
			KS_Explorer.Selected = inst
			nameLabel.Text = "Instance: "..inst.Name.." ("..inst.ClassName..")"

			for _, c in ipairs(propList:GetChildren()) do
				if c:IsA("TextLabel") then c:Destroy() end
			end

			for _, p in ipairs({"Name","ClassName","Parent","Archivable","Transparency","Anchored","CanCollide","Text","Value"}) do
				local ok, v = pcall(function() return inst[p] end)
				if ok then addPropRow(p,v) end
			end
			propList.CanvasSize = UDim2.new(0,0,0,propLayout.AbsoluteContentSize.Y+8)
		end)

		-- double-click = open editor
		local lastClick = 0
		btn.MouseButton1Click:Connect(function()
			local now = tick()
			if now - lastClick <= 0.3 then
				KS_Editor.Open(inst)
			end
			lastClick = now
		end)

		for _, child in ipairs(inst:GetChildren()) do
			buildTree(child, depth+1)
		end
	end

	for _, root in ipairs({
		game:GetService("Workspace"),
		game:GetService("Players"),
		game:GetService("ReplicatedStorage"),
		game:GetService("StarterGui"),
	}) do
		if root then buildTree(root,0) end
	end

	tree.CanvasSize = UDim2.new(0,0,0,treeLayout.AbsoluteContentSize.Y+8)

	btnEdit.MouseButton1Click:Connect(function()
		if KS_Explorer.Selected then KS_Editor.Open(KS_Explorer.Selected) end
	end)
	btnExport.MouseButton1Click:Connect(function()
		local inst = KS_Explorer.Selected
		if not inst then return end
		if inst:IsA("LuaSourceContainer") then
			safe(KS_UTIL.exportScript, inst)
		else
			safe(KS_UTIL.exportInstance, inst, {name = inst.Name})
		end
	end)
	btnClose.MouseButton1Click:Connect(function()
		gui.Enabled = false
	end)

	makeDraggable(top, main)
	KS_Explorer.Gui = gui
end

function KS_Explorer.Toggle()
	createExplorerGui()
	KS_Explorer.Gui.Enabled = not KS_Explorer.Gui.Enabled
end

_G.KS_Explorer = KS_Explorer

-------------------------------
-- Korone Remote Spy (IY-style, but lighter)
-------------------------------
local KS_RSpy = { Gui = nil, Enabled = true, AddLog = nil }

local function createRSpyGui()
	if KS_RSpy.Gui then return end

	local gui = Instance.new("ScreenGui")
	gui.Name = "KoroneRemoteSpy"
	gui.ResetOnSpawn = false
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	gui.Enabled = false
	gui.Parent = CoreGui

	local main = Instance.new("Frame")
	main.AnchorPoint = Vector2.new(1,0.5)
	main.Position = UDim2.new(1,-16,0.5,0)
	main.Size = UDim2.new(0,480,0,280)
	main.BackgroundColor3 = Color3.fromRGB(18,18,20)
	main.BorderSizePixel = 0
	main.Parent = gui
	local mc = Instance.new("UICorner"); mc.CornerRadius = UDim.new(0,10); mc.Parent = main

	local top = Instance.new("Frame")
	top.Size = UDim2.new(1,0,0,30)
	top.BackgroundColor3 = Color3.fromRGB(26,26,30)
	top.BorderSizePixel = 0
	top.Parent = main
	local tc = Instance.new("UICorner"); tc.CornerRadius = UDim.new(0,10); tc.Parent = top

	local title = Instance.new("TextLabel")
	title.BackgroundTransparency = 1
	title.Size = UDim2.new(1,-110,1,0)
	title.Position = UDim2.new(0,8,0,0)
	title.Font = Enum.Font.SourceSansSemibold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.TextColor3 = Color3.new(1,1,1)
	title.Text = "üì° Korone Remote Spy"
	title.Parent = top

	local btnClose = Instance.new("TextButton")
	btnClose.Size = UDim2.new(0,26,0,22)
	btnClose.Position = UDim2.new(1,-30,0.5,-11)
	btnClose.BackgroundColor3 = Color3.fromRGB(70,35,35)
	btnClose.BorderSizePixel = 0
	btnClose.Font = Enum.Font.SourceSansBold
	btnClose.Text = "X"
	btnClose.TextSize = 16
	btnClose.TextColor3 = Color3.new(1,1,1)
	btnClose.Parent = top
	local bcc = Instance.new("UICorner"); bcc.CornerRadius = UDim.new(0,6); bcc.Parent = btnClose

	local btnToggle = Instance.new("TextButton")
	btnToggle.Size = UDim2.new(0,90,0,22)
	btnToggle.Position = UDim2.new(1,-130,0.5,-11)
	btnToggle.BackgroundColor3 = Color3.fromRGB(45,90,45)
	btnToggle.BorderSizePixel = 0
	btnToggle.Font = Enum.Font.SourceSansSemibold
	btnToggle.Text = "Enabled"
	btnToggle.TextSize = 14
	btnToggle.TextColor3 = Color3.new(1,1,1)
	btnToggle.Parent = top
	local btc = Instance.new("UICorner"); btc.CornerRadius = UDim.new(0,6); btc.Parent = btnToggle

	local log = Instance.new("ScrollingFrame")
	log.Name = "Log"
	log.Position = UDim2.new(0,4,0,34)
	log.Size = UDim2.new(1,-8,1,-38)
	log.BackgroundColor3 = Color3.fromRGB(20,20,22)
	log.BorderSizePixel = 0
	log.ScrollBarThickness = 6
	log.CanvasSize = UDim2.new(0,0,0,0)
	log.Parent = main
	local lc = Instance.new("UICorner"); lc.CornerRadius = UDim.new(0,6); lc.Parent = log

	local layout = Instance.new("UIListLayout")
	layout.Padding = UDim.new(0,2)
	layout.FillDirection = Enum.FillDirection.Vertical
	layout.SortOrder = Enum.SortOrder.LayoutOrder
	layout.Parent = log

	local function addLog(line)
		local row = Instance.new("TextLabel")
		row.BackgroundTransparency = 1
		row.Size = UDim2.new(1,-4,0,18)
		row.Font = Enum.Font.SourceSans
		row.TextSize = 13
		row.TextXAlignment = Enum.TextXAlignment.Left
		row.TextColor3 = Color3.new(1,1,1)
		row.Text = line
		row.Parent = log
		log.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+8)
	end

	KS_RSpy.AddLog = addLog

	btnToggle.MouseButton1Click:Connect(function()
		KS_RSpy.Enabled = not KS_RSpy.Enabled
		btnToggle.Text = KS_RSpy.Enabled and "Enabled" or "Disabled"
		btnToggle.BackgroundColor3 = KS_RSpy.Enabled and Color3.fromRGB(45,90,45) or Color3.fromRGB(90,45,45)
	end)

	btnClose.MouseButton1Click:Connect(function()
		gui.Enabled = false
	end)

	makeDraggable(top, main)
	KS_RSpy.Gui = gui
end

-- namecall hook (like Infinite Yield style behaviour)
do
	local hook = rawget(getfenv(), "hookmetamethod")
	local getncm = rawget(getfenv(), "getnamecallmethod") or getnamecallmethod

	if hook and getncm then
		local old
		old = hook(game, "__namecall", function(self, ...)
			local method = getncm()
			if KS_RSpy.Enabled and (method == "FireServer" or method == "InvokeServer") then
				if typeof(self) == "Instance" and (self:IsA("RemoteEvent") or self:IsA("RemoteFunction")) then
					local args = {...}
					local ok, encoded = pcall(HttpService.JSONEncode, HttpService, args)
					if ok and KS_RSpy.AddLog then
						KS_RSpy.AddLog(("[%s] %s(%s)"):format(method, self:GetFullName(), encoded))
					end
				end
			end
			return old(self, ...)
		end)
	else
		warn("[KoroneRemoteSpy] hookmetamethod / getnamecallmethod not available; RSpy requires an executor with those.")
	end
end

function KS_RSpy.Toggle()
	createRSpyGui()
	KS_RSpy.Gui.Enabled = not KS_RSpy.Gui.Enabled
end

_G.KS_RSpy = KS_RSpy

-------------------------------
-- Main Korone Studio Hub (emoji UI)
-------------------------------
local function createHub()
	if CoreGui:FindFirstChild("KoroneStudioHub") then
		return CoreGui.KoroneStudioHub
	end

	local gui = Instance.new("ScreenGui")
	gui.Name = "KoroneStudioHub"
	gui.ResetOnSpawn = false
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	gui.Parent = CoreGui

	local main = Instance.new("Frame")
	main.AnchorPoint = Vector2.new(0,0.5)
	main.Position = UDim2.new(0,16,0.5,0)
	main.Size = UDim2.new(0,260,0,190)
	main.BackgroundColor3 = Color3.fromRGB(18,18,20)
	main.BorderSizePixel = 0
	main.Parent = gui
	local mc = Instance.new("UICorner"); mc.CornerRadius = UDim.new(0,12); mc.Parent = main

	local top = Instance.new("Frame")
	top.Size = UDim2.new(1,0,0,32)
	top.BackgroundColor3 = Color3.fromRGB(26,26,30)
	top.BorderSizePixel = 0
	top.Parent = main
	local tc = Instance.new("UICorner"); tc.CornerRadius = UDim.new(0,12); tc.Parent = top

	local title = Instance.new("TextLabel")
	title.BackgroundTransparency = 1
	title.Size = UDim2.new(1,-64,1,0)
	title.Position = UDim2.new(0,12,0,0)
	title.Font = Enum.Font.SourceSansSemibold
	title.TextSize = 18
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.TextColor3 = Color3.new(1,1,1)
	title.Text = "üåô Korone Studio Tools"
	title.Parent = top

	local btnMin = Instance.new("TextButton")
	btnMin.Size = UDim2.new(0,24,0,24)
	btnMin.Position = UDim2.new(1,-60,0.5,-12)
	btnMin.BackgroundColor3 = Color3.fromRGB(40,40,50)
	btnMin.BorderSizePixel = 0
	btnMin.Font = Enum.Font.SourceSansBold
	btnMin.Text = "-"
	btnMin.TextSize = 18
	btnMin.TextColor3 = Color3.new(1,1,1)
	btnMin.Parent = top
	local bmc = Instance.new("UICorner"); bmc.CornerRadius = UDim.new(0,6); bmc.Parent = btnMin

	local btnClose = Instance.new("TextButton")
	btnClose.Size = UDim2.new(0,24,0,24)
	btnClose.Position = UDim2.new(1,-30,0.5,-12)
	btnClose.BackgroundColor3 = Color3.fromRGB(70,35,35)
	btnClose.BorderSizePixel = 0
	btnClose.Font = Enum.Font.SourceSansBold
	btnClose.Text = "X"
	btnClose.TextSize = 16
	btnClose.TextColor3 = Color3.new(1,1,1)
	btnClose.Parent = top
	local bcc = Instance.new("UICorner"); bcc.CornerRadius = UDim.new(0,6); bcc.Parent = btnClose

	local content = Instance.new("Frame")
	content.Position = UDim2.new(0,0,0,32)
	content.Size = UDim2.new(1,0,1,-32)
	content.BackgroundTransparency = 1
	content.Parent = main

	local layout = Instance.new("UIListLayout")
	layout.Padding = UDim2.new(0,6)
	layout.FillDirection = Enum.FillDirection.Vertical
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	layout.VerticalAlignment = Enum.VerticalAlignment.Top
	layout.SortOrder = Enum.SortOrder.LayoutOrder
	layout.Parent = content

	local padding = Instance.new("UIPadding")
	padding.PaddingTop = UDim2.new(0,10)
	padding.PaddingBottom = UDim2.new(0,10)
	padding.PaddingLeft = UDim2.new(0,10)
	padding.PaddingRight = UDim2.new(0,10)
	padding.Parent = content

	local function makeButton(text, sub, color)
		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(1,0,0,40)
		btn.BackgroundColor3 = color
		btn.BorderSizePixel = 0
		btn.AutoButtonColor = true
		btn.Text = ""
		btn.Parent = content
		local bc = Instance.new("UICorner"); bc.CornerRadius = UDim2.new(0,8); bc.Parent = btn

		local l1 = Instance.new("TextLabel")
		l1.BackgroundTransparency = 1
		l1.Size = UDim2.new(1,-8,0,22)
		l1.Position = UDim2.new(0,8,0,2)
		l1.Font = Enum.Font.SourceSansSemibold
		l1.TextSize = 17
		l1.TextXAlignment = Enum.TextXAlignment.Left
		l1.TextColor3 = Color3.new(1,1,1)
		l1.Text = text
		l1.Parent = btn

		local l2 = Instance.new("TextLabel")
		l2.BackgroundTransparency = 1
		l2.Size = UDim2.new(1,-8,0,16)
		l2.Position = UDim2.new(0,8,0,22)
		l2.Font = Enum.Font.SourceSans
		l2.TextSize = 13
		l2.TextXAlignment = Enum.TextXAlignment.Left
		l2.TextColor3 = Color3.fromRGB(230,230,230)
		l2.TextTransparency = 0.1
		l2.Text = sub
		l2.Parent = btn

		return btn
	end

	local explorerBtn = makeButton("üóÇ Explorer", "Browse instances and open scripts", Color3.fromRGB(56,102,65))
	local rspyBtn     = makeButton("üì° Remote Spy", "Log FireServer / InvokeServer", Color3.fromRGB(70,64,120))
	local editorBtn   = makeButton("‚úèÔ∏è Editor", "Edit LocalPlayer or any instance", Color3.fromRGB(59,89,152))

	explorerBtn.MouseButton1Click:Connect(function() KS_Explorer.Toggle() end)
	rspyBtn.MouseButton1Click:Connect(function() KS_RSpy.Toggle() end)
	editorBtn.MouseButton1Click:Connect(function() KS_Editor.Open(LocalPlayer) end)

	btnMin.MouseButton1Click:Connect(function()
		main.Visible = not main.Visible
	end)
	btnClose.MouseButton1Click:Connect(function()
		gui.Enabled = false
	end)

	makeDraggable(top, main)
	return gui
end

local hub = createHub()
_G.KoroneStudioHub = hub

print("[KoroneStudio] Loaded. Use the üåô Korone Studio Tools panel on the left.")
